name: PR gate workflow
on:
  pull_request:
    branches:
      - main
      - master
jobs:
  pr-gate:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: development
    steps:
      - name: Configure Linux
        run: echo 16384 | sudo tee /proc/sys/fs/inotify/max_user_watches
      - name: Set up environment
        run: |
          if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
            echo "DEPENDABOT_PRIVATE_PACKAGE_TOKEN used for NODE_AUTH_TOKEN"
            echo "NODE_AUTH_TOKEN=${{ secrets.DEPENDABOT_PRIVATE_PACKAGE_TOKEN }}" >> $GITHUB_ENV
          else
            echo "GIT_PACKAGE_TOKEN used for NODE_AUTH_TOKEN"
            echo "NODE_AUTH_TOKEN=${{ secrets.GIT_PACKAGE_TOKEN }}" >> $GITHUB_ENV
          fi
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16.15.0'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@vertexinc'
      - id: install-dependencies
        name: Install dependencies
        uses: bahmutov/npm-install@v1
      - name: Install dependencies (failure)
        if: failure() && steps.install-dependencies.outcome == 'failure'
        run: echo 'If a @vertexinc-scoped package failed to install, please ensure that the SystemTeamAutomation GitHub user has access to the repository that failed to install.  The GIT_PACKAGE_TOKEN secret (which is necessary to authorize the `npm install` command) is owned by that account and is only available to repos that that account has access to.'
      - name: Lint
        run: npm run lint
      - name: Build
        run: npm run build:${{ env.NODE_ENV }}

