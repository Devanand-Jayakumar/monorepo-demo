name: Run E2E Tests
on:
  push:
    branches: 
     - main
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  cypress-run:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: '${{ github.ref_name }}'
      - name: Build reports.json
        run: |
          git fetch origin gh-pages
          git checkout origin/gh-pages -- .
          node -e "const fs=require('fs'); \
          const isRpt=d=>/^[0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}$/.test(d) && fs.statSync(d).isDirectory(); \
          const dirs=(fs.existsSync('.')?fs.readdirSync('.'):[]).filter(isRpt).sort().reverse(); \
          const out={reports: dirs.map(d=>({ folder:d, url:`${d}/index.html`})) }; \
          fs.writeFileSync('reports.json', JSON.stringify(out,null,2));"
      - name: Prepare site files
        run: |
          mkdir -p site-publish
          cp reports.json site-publish/
          cp allure-homepage.html site-publish/index.html
      - name: Deploy reports.json + index.html
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site-publish
          keep_files: true
      - name: Exit after upload
        run: exit 0
